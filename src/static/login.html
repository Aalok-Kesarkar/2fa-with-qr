<!DOCTYPE html>
<html lang="en">

<head>
    <title>Login</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="style.css" media="screen" type="text/css" />
    <link rel="stylesheet" href="Style1.Css" media="screen" type="text/css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <!-- <script type="text/javascript" src="jquery.store.js"></script> -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
</head>


<body>

    <section id="nav-bar">
        <nav class="navbar navbar-expand-lg navbar-light" style="background-color: green;">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="pull-right">
                <a style="color:white; font-size: 30px;" href="index.html">Snap Buy</a>
            </div>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a style="color:white;" class="nav-link" href="index.html">Home</a>
                    </li>

                    <li class="nav-item">
                        <a style="color:white;" class="nav-link" href="product.html">Products</a>
                    </li>

                    <li class="nav-item">
                        <a style="color:white;" class="nav-link" href="cart.html">Cart</a>
                    </li>

                    <li class="nav-item">
                        <a style="color:white;" class="nav-link" href="aboutus.html">About Us</a>
                    </li>

                    <li class="nav-item">
                        <a style="color:white;" id="profile_button" class="nav-link" href="view-user.html"
                            hidden>Profile</a>
                    </li>

                    <li class="nav-item">
                        <a style="color:white;" id="login_button" class="nav-link" href="login.html">Login/Signup</a>
                    </li>
                </ul>
            </div>
        </nav>
    </section>

    <center>
        <section id="log_in">
            <div class="container">
                <h1>Login</h1>
                <div class="row">
                    <div class="col-md-6">
                        <form class="log_in-form">
                            <div class="form-group">
    </center>


    <center>
        <form id="log_in">
            <!-- We will expect email and correct password from user for logging in -->
            <div class="form-group">
                <input type="text" name="user_email" id="user_email" placeholder="Email" required />
            </div>
            <div class="form-group">
                <input type="password" name="user_password" id="user_password" placeholder="Password" required />
            </div>
            <!-- </center>   -->

            <!-- User need to choose any one authentication method (OTP or QR) for 2 step authentication -->
            <!-- <center>   -->
            <input type="radio" id="otp" name="auth_method" value="otp" required>
            <label for="otp">OTP</label>

            <input type="radio" id="qr" name="auth_method" value="qr">
            <label for="qr">QR Code</label>
            <div class="form-group">
                <input class="ptn ptn1" type="submit" id="get_code" value="Get Code" />
            </div>
        </form>
    </center>

    <center>
        <form id="otp_form">
            <!-- following fields will be 'hidden' by default, depend on selection of OTP or QR following fields will be visible -->
            <input type="text" name="otp_field" id="otp_field" placeholder="One Time Password" hidden />
            <input type="button" name="verify_otp_btn" id="verify_otp_btn" value="Login" hidden />

            <input type="file" id="qr_field" hidden />
            <img src="" height="200" alt="QR preview..." hidden />
            <input type="button" class="ptn ptn1" name="verify_qr_btn" id="verify_qr_btn" value="Login" hidden />
        </form>
    </center>

    <center>
        <h4>
            <p id="msg_from_server" style="font-family: Arial, Helvetica, sans-serif;"></p>
        </h4>

        <!-- <input type="button" name="resend_otp" id="resend_otp" value="Resend OTP" style="margin-top: 5px;" /> -->

        <h3>Don't have an account? <a style="font-size:25px;" href="signup.html">Signup</a></h3>
    </center>


    <script>
        const form = document.getElementById('log_in')
        const resendCode = document.getElementById('get_code')

        resendCode.addEventListener('click', loginUser)

        function validateLogin(e) {
            e.preventDefault()
            let email = document.getElementById('user_email').value;

            let regxEmail = /^([ a-z A-Z 0-9 \.]+)@([ a-z ]+)\.([ a-z ]+)$/;
            if ((regxEmail.test(email))) {
                // document.getElementById('validityMsg').style.visibility = "hidden";
                loginUser()
            } else {
                alert('Please enter valid email address')
                // document.getElementById('validityMsg').style.visibility = "visible"; //if condition satisfies this shows error text beside usernme field
            }
        }
        document.getElementById('log_in').addEventListener('submit', validateLogin)

        document.getElementById('msg_from_server').innerText = ''

        // 'loginUser' function definition
        // at first we will verify that user exists or not in our mongoDB database with these email and password.
        async function loginUser() {
            const email = document.getElementById('user_email').value
            const password = document.getElementById('user_password').value

            // extract authMethod (OTP or QR) from radio buttons in HTML code
            let authMethod
            document.getElementsByName('auth_method')
                .forEach(radio => {
                    if (radio.checked) {
                        authMethod = radio.value
                    }
                })

            document.getElementById('msg_from_server').innerText = 'Loading...'

            // fetch request to backend by sending email and password entered by user.
            const result = await fetch(`/user/login?verifMethod=${authMethod}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }, body: JSON.stringify({
                    email,
                    password
                })
            }).then(res => res.json())

            if (result.status === 'ok') {
                if (authMethod === 'otp') {
                    document.getElementById('qr_field').hidden = true
                    document.getElementById('verify_qr_btn').hidden = true

                    document.getElementById('otp_field').hidden = false
                    document.getElementById('verify_otp_btn').hidden = false

                    verifyOTP('otp')

                    document.getElementById('get_code').value = 'Resend OTP'

                    document.getElementById('msg_from_server').innerText = result.message
                } else if (authMethod === 'qr') {
                    document.getElementById('otp_field').hidden = true
                    document.getElementById('verify_otp_btn').hidden = true

                    document.getElementById('qr_field').hidden = false
                    document.getElementById('verify_qr_btn').hidden = false

                    verifyQR('qr')

                    document.getElementById('get_code').value = 'Resend QR'

                    document.getElementById('msg_from_server').innerText = result.message
                }
            } else if (result.status === 'error') {
                document.getElementById('msg_from_server').innerText = `Couldn't process your request!`
                console.log('ERROR: ', result.message)
            }

            // Function to verifying OTP
            function verifyOTP(method) {

                document.getElementById('verify_otp_btn').addEventListener('click', verify_otp)

                async function verify_otp(event) {
                    event.preventDefault()
                    const otp = document.getElementById('otp_field').value
                    const email = document.getElementById('user_email').value

                    document.getElementById('msg_from_server').innerText = 'Verifying OTP...'

                    const result = await fetch('/user/validate-login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }, body: JSON.stringify({
                            email,
                            otp
                        })
                    }).then(res => res.json())

                    if (result.status == 'ok') {
                        localStorage.setItem('token', result.token)

                        document.getElementById('login_button').hidden = true
                        document.getElementById('profile_button').hidden = false
                    }
                    document.getElementById('msg_from_server').innerText = result.message
                }
            }

            // Function for verifying QR code
            function verifyQR(method) {
                document.getElementById('verify_qr_btn').addEventListener('click', verify_qr)

                function verify_qr(event) {
                    event.preventDefault()
                    const email = document.getElementById('user_email').value
                    const file = document.querySelector('#qr_field').files[0];
                    // const img = document.getElementById('qr_field')

                    document.getElementById('msg_from_server').innerText = 'Verifying QR...'

                    window.addEventListener('paste', e => {
                        file.files[0] = e.clipboardData.files;
                    });

                    const preview = document.querySelector('img');
                    const reader = new FileReader();

                    const qrBase64 = reader.addEventListener("load", async function () {
                        // convert image file to base64 string
                        preview.src = reader.result;
                        let qr = preview.src

                        const result = await fetch('/user/verify-qr', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }, body: JSON.stringify({
                                email,
                                qr
                            })
                        }).then(res => res.json())

                        if (result.status == 'ok') {
                            localStorage.setItem('token', result.token)

                            document.getElementById('login_button').hidden = true
                            document.getElementById('profile_button').hidden = false
                        }
                        document.getElementById('msg_from_server').innerText = result.message
                    }, false);

                    if (file) {
                        reader.readAsDataURL(file);
                    }
                }
            }
        }
    </script>
</body>

</html>