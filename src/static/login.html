<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log In</title>
</head>

<body>
    <h1>Login page</h1>
    <form id="log_in">
        <!-- We will expect email and correct password from user for logging in -->
        <input type="text" name="user_email" id="user_email" placeholder="Email" required />
        <input type="password" name="user_password" id="user_password" placeholder="Password" required />

        <!-- User need to choose any one authentication method (OTP or QR) for 2 step authentication -->
        <input type="radio" id="otp" name="auth_method" value="otp" required>
        <label for="otp">OTP</label>
        <input type="radio" id="qr" name="auth_method" value="qr">
        <label for="qr">QR Code</label>

        <input type="submit" value="Get Code" />
    </form><br><br>

    <form id="otp_form">
        <!-- following fields will be 'hidden' by default, depend on selection of OTP or QR following fields will be visible -->
        <input type="text" name="otp_field" id="otp_field" placeholder="One Time Password" hidden />
        <input type="button" name="verify_otp_btn" id="verify_otp_btn" value="Login" hidden />

        <input type="file" id="qr_field" hidden />
        <img src="" height="200" alt="QR preview..." hidden />
        <input type="button" name="verify_qr_btn" id="verify_qr_btn" value="Login" hidden />

    </form><br>

    <a href="view-user.html" id="view_user_profile_link" hidden>View my profile</a>

    <p id="msg_from_server" style="font-family: Georgia, 'Times New Roman', Times, serif;"></p>

    <input type="button" name="resend_otp" id="resend_otp" value="Resend OTP" style="margin-top: 100px;" />

    <!-- JAVASCRIPT CODE BELOW -->
    <script>
        const form = document.getElementById('log_in')
        const resendOTP = document.getElementById('resend_otp')

        // on subimitting email and password by user, 'loginUser' function will be called.
        form.addEventListener('submit', loginUser)
        resendOTP.addEventListener('click', loginUser)

        document.getElementById('msg_from_server').innerText = ''

        // 'loginUser' function definition
        // at first we will verify that user exists or not in our mongoDB database with these email and password.
        async function loginUser(event) {
            event.preventDefault()
            const email = document.getElementById('user_email').value
            const password = document.getElementById('user_password').value

            // extract authMethod (OTP or QR) from radio buttons in HTML code
            let authMethod
            document.getElementsByName('auth_method')
                .forEach(radio => {
                    if (radio.checked) {
                        authMethod = radio.value
                    }
                })

            document.getElementById('msg_from_server').innerText = 'Loading...'

            // fetch request to backend by sending email and password entered by user.
            const result = await fetch(`/user/login?verifMethod=${authMethod}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }, body: JSON.stringify({
                    email,
                    password
                })
            }).then(res => res.json())

            if (result.status === 'ok') {
                if (authMethod === 'otp') {
                    document.getElementById('qr_field').hidden = true
                    document.getElementById('verify_qr_btn').hidden = true

                    document.getElementById('otp_field').hidden = false
                    document.getElementById('verify_otp_btn').hidden = false

                    document.getElementById('msg_from_server').innerText = result.message
                } else if (authMethod === 'qr') {
                    document.getElementById('otp_field').hidden = true
                    document.getElementById('verify_otp_btn').hidden = true

                    document.getElementById('qr_field').hidden = false
                    document.getElementById('verify_qr_btn').hidden = false

                    document.getElementById('msg_from_server').innerText = result.message
                }
            } else if (result.status === 'error') {
                document.getElementById('msg_from_server').innerText = `Couldn't process your request!`
                console.log('ERROR: ', result.message)
            }

            // Verifying with 2 factor authentication
            // If OTP is expected...
            if (document.getElementById('verify_otp_btn').hidden === false) {

                document.getElementById('verify_otp_btn').addEventListener('click', verify_otp)

                async function verify_otp(event) {
                    event.preventDefault()
                    const otp = document.getElementById('otp_field').value
                    const email = document.getElementById('user_email').value

                    document.getElementById('msg_from_server').innerText = 'Verifying OTP...'

                    const result = await fetch('/user/validate-login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }, body: JSON.stringify({
                            email,
                            otp
                        })
                    }).then(res => res.json())

                    if (result.status == 'ok') {
                        localStorage.setItem('token', result.token)
                        document.getElementById('view_user_profile_link').hidden = false
                    }
                    document.getElementById('msg_from_server').innerText = result.message
                }

                // IF QR code is expected...
            } else if (document.getElementById('verify_qr_btn').hidden === false) {
                document.getElementById('verify_qr_btn').addEventListener('click', verify_qr)

                function verify_qr(event) {
                    event.preventDefault()
                    const email = document.getElementById('user_email').value
                    const file = document.querySelector('#qr_field').files[0];
                    // const img = document.getElementById('qr_field')

                    document.getElementById('msg_from_server').innerText = 'Verifying QR...'

                    window.addEventListener('paste', e => {
                        file.files[0] = e.clipboardData.files;
                    });

                    const preview = document.querySelector('img');
                    const reader = new FileReader();

                    const qrBase64 = reader.addEventListener("load", async function () {
                        // convert image file to base64 string
                        preview.src = reader.result;
                        let qr = preview.src

                        const result = await fetch('/user/verify-qr', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }, body: JSON.stringify({
                                email,
                                qr
                            })
                        }).then(res => res.json())

                        if (result.status == 'ok')
                            localStorage.setItem('token', result.token)

                        document.getElementById('msg_from_server').innerText = result.message
                    }, false);

                    if (file) {
                        reader.readAsDataURL(file);
                    }
                }
            } else {
                console.log('Error thrown')
            }
        }
    </script>
</body>

</html>